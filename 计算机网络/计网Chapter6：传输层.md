## 传输层

传输层的目的：**解决端到端的通信。**

相关协议：TCP、UDP

### TCP的流量控制

### TCP的拥塞控制

拥塞控制指的是

### TCP超时重传时间的选择

​		首先要知道RTT，要根据RTT设置超时重传时间（RTO），RTO略大于RTT即可。然而复杂的互联网环境使得每个报文段的RTT不一样，故不能直接使用某次的RTT样本计算RTO，可以计算加权平均
$$
RTT_{S} = (1 - α) * RTT_S + α * RTT_{new}
$$
RFC6298建议使用下式计算RTO：
$$
RTO = RTT_S + 4 * RTT_D
$$
其中
$$
RTT_D = (1 - β) * RTT_D + β * abs(RTT_S - RTT_{new})
$$

$$
其中：RTT_{S1} = RTT_1;
RTT_{D1} = RTT_1 / 2
$$

测量RTT会出现许多情况导致RTT不准确（偏大或偏小），进而无法计算RTO。

Karn提出了算法：在计算RTT时，只要报文段重传了就不计算RTT样本，进而RTO也不会重新计算，但会可能出现一直超时重传的情况。

Karn算法修正：报文段每重传一次，就把超时重传时间RTO增大一些。典型的做法是将新RTO值取为旧RTO的2倍 ，**出现超时重传时，新RTO = 2倍的旧RTO**

### TCP可靠传输的实现

TCP基于**以字节为单位的滑动窗口**来实现可靠传输

可以使用3个指针描述发送窗口的状态

注意：

1. **发送窗口并不总是和接收窗口一样大**
2. **不按序到达的数据有多种处理方式**
3. **TCP要求接收方必须有累计确认和捎带确认机制**
4. **TCP通信是全双工通信**

### TCP的运输连接管理——TCP的连接建立

运输连接有以下三个阶段

1. 建立TCP连接（三报文握手）
2. 数据传送
3. 释放连接

#### 三报文握手

#### 四报文挥手

### TCP报文的首部格式

TCP采用面向字节流的方式，一个TCP报文段由首部和数据载荷组成

首部格式：固定首部（20字节）+拓展首部（最大40字节）

1. 源端口、目的端口：2字节
2. 序号：4字节
3. 确认号：4字节

### 传输层课后习题

1. 在 OSI 模型中,哪一层位于资源子网和通信子网之间?    答：传输层(运输层)
2. 传输层的具体功能有哪些?    答：传输层负责总体的数据传输和数据控制；并且提供**端到端的交换数据的机制**
3. 什么是传输层的复用功能?它分为哪两种,分别用在什么情况下?    答：传输层复用就是多个应用层进程汇聚成一个传输器进程；而分用就是一个传输层的多个进程通向多个应用进程。分为TCP和UDP。TCP一般适用于对效率要求低，对准确性要求高或者要求有连接的场景；而UDP适用于对效率要求高，而对准确性要求低的场景。
4. 数据链路层己经有差错控制,为什么传输层还需要差错控制?   答：
5. 什么是次序控制?什么是分段?什么是拼接?
6. 什么是丢失控制?什么是重复控制?
7. 传输层的滑动窗口和数据链路层的滑动窗口有什么不同?
8.  OSI 传输层的连接建立和连接终止,发送方和接收方各需交换几次信息?    答：发送方4次，接收方3次
9. OSI网络层服务有哪几类?
10. OSI 传输层服务有哪几类?它们与网络层服务有什么关系?
11. OSI的传输服务原语有哪些?
12. 一个连接端点在生命周期内有哪几种状态?
13. **说明 UDP 协议和 TCP 协议的特点和功能。**答：**UDP特点**：无连接、不可靠交付、面向报文、无拥塞控制、支持多对多通信、首部开销小；**TCP特点**：面向连接、可靠传输、面向字节流、全双工通信、点对点连接
14. **说明 TCP 协议建立连接的过程。**  答：分为3个阶段：建立TCP连接；数据传送；释放TCP连接。TCP连接**”三报文握手“**首先TCP客户创建传输控制块，其次发送TCP连接请求，在等到TCP服务器发送TCP连接请求的确认，最后TCP客户再发送一个针对TCP连接请求的确认的确认（该报文可以携带数据），此时TCP双方都进入连接已建立状态。注意：**最后一条报文是为了解决TCP连接请求超时重传的情况**。TCP通过**“四报文挥手”**来释放连接，首先TCP客户发送TCP连接释放报文段，TCP服务器发送TCP普通确认报文段，当TCP服务器没有数据向TCP客户传输时，TCP服务器发送TCP连接释放报文段，最后TCP客户发送TCP普通确认报文段，等待数分钟后，TCP客户切换至关闭状态，TCP服务器进程最终也进入关闭状态。
15. 简要说明TCP连接时所用到的TCP报头信息有哪些？   答：六个标志位中要使用三个：首先是**SYN**：SYN= 1 表示这是一个连接请求或连接接受报文。在建立连接时用来进行同步序号（个人理解是，在建立连接的时候，提醒对方记录本方的起始序号）。当SYN=1而ACK=0时，表明这是一个连接请求报文段。对方若是同意建立连接，则应响应的报文段中使SYN=1、ACK=1。因此SYN=1表示该报文是一个连接请求报文或者是一个连接请求接收报文。**ACK**：确认号只有在该位设置为1的时候才生效，当该位为0是表示确认号无效。TCP规定，在TCP连接建立后所有传送的数据报文段ACK都必须设置为1。**FIN**：当 FIN = 1 时，表明此报文段的发送方的数据已经发送完毕，并要求释放连接。此外还要用到序号和确认号，**序号seq**：占4个字节，它的范围在0-2^32-1，序号随着通信的进行不断的递增，当达到最大值的时候重新回到0在开始递增。TCP是面向字节流的，在一个TCP连接中传送的字节流中的每一个字节都按照顺序编号。整个要传送的字节流的起始号必须在连接建立时设置。首部中的序列号字段指的是本报文段所发送的数据的第一个字节的序号。例如，一个报文序号是301，而携带的数据共有100字节。则表示本次报文中的序号是301，下一个报文的序号是401.重复一下，每一个报文的序号是该报文包含的字节中第一个字节的编号。**确认号ack**：占4个字节，确认号，是对下一个想要接受的字节的期望，这里隐式确认了对上一个数据包的成功接收。如上例，在成功接收了序号为301的数据包，想要接收下一个数据包因为上个数据包包含100字节，所以此时的确认号应该是401，表示希望接收下一个序号是401的数据包。
16. TCP 报头中的哪些域与拥塞控制、流量控制和差错控制有关?    答：拥塞控制
17. **说明 TCP 拥塞控制的慢启动和拥塞避免算法。**答：慢启动算法在发送窗口(swnd)小于等于慢开始门限（ssthresh）时使用的算法，是指在最开始进行发送报文时，发送窗口值为1，在每次收到接收方的ACK报文时，发送窗口扩大至原来的2倍；拥塞避免算法是指在发送窗口（swnd）大于等于阈值（ssthreth）的情况下，每次收到ACK报文时发送窗口较原来只能线性增加1；当遇到重传计时器超时的情况时，将swnd值重新至为1，并且将ssthreth值减半，重新开始慢启动算法。
18. **说明 TCP 拥塞控制的快速重传和快速恢复算法。**  答：快速重传指发送方一旦收到3个连续的重复确认就将相应的报文段立即重传，而不是等超时重传计时器超时再重传；快速恢复算法是指收到3个重复确认时将ssthreth和swnd值调整为当前值的一半，之后开始执行拥塞避免算法。
