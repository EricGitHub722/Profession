# 网络层

目的：不同网络之间要进行数据包的传输

网络层需要解决的问题：

1. **可靠or不可靠**
2. **网络层如何寻址**
3. **路由如何选择**

因特网使用TCP/IP协议栈，由于TCP/IP协议栈的网络层使用网际协议IP，故这样的网络层又被称为**网际层**

### 网络层提供的两种服务

1. 面向连接虚电路服务
2. 面向无连接的数据报服务

虚电路服务：**可靠通信靠网络来保证；须建立网络层连接；所有分组均按照同一路转发；顺序到达终点；容易实现但无灵活性**

数据报服务：**可靠通信由用户主机来保证（不可靠传输）；不需建立连接；每个分组都有终点的完整地址；分组的路径可以不同；不一定按序到达；较难保证服务质量**

面向连接的网络服务的传输过程：

1. 发送者发送连接请求包
2. 接收者使用连接确认包进行确认
3. 发送者传输数据
4. 发送者发送连接终止请求包
5. 接收者使用连接终止包进行确认

### IPv4

IPv4地址是为每一台主机（或路由器）的每一个接口分配一个唯一的32bit的标识符

#### IPv4表示方法

点分十进制法表示，每8位表示一个十进制数，例如10.240.15.170

### 分类编址的IPv4地址

![image-20211204095552817](C:\Users\huawei\AppData\Roaming\Typora\typora-user-images\image-20211204095552817.png)

### 划分子网的IPv4地址

目的：合理分配网络地址，并且优化记录方式

将原有的两级地址划分为三级地址

子网掩码的目的：可以表明分类IP地址的主机号部分被借用了多少比特作为子网号，网络号与子网号部分都为1，其余都为0

子网掩码用法：**先判断是A or B or C类地址，其次找到主机号的部位，最后看子网掩码借用了多少比特作为子网号，即可得出划分出的子网数量，以及每个子网可以分配的地址数量，该方法与分类编制的IPv4做法相同，在计算地址数量时，将网络号和借用的位当成分类编制的网络号，剩余部分按分类编址的方法计算即可。（注：划分子网的分配方式会比原来分类编址的分配方式多出很多（与子网号数量相关）的网络地址与广播地址。）**

注意：发送广播分组时的目的地址为主机所在子网的广播地址

#### 默认子网掩码

是指未划分子网的情况下使用的子网掩码，1的长度与对应地址的网络号长度相同

### 无分类编制的IPv4地址

目的：划分子网不能从根本上解决IPv4地址耗尽问题

CIDR：无分类域间路由选择

CIDR的特点：消除了分类编制与划分子网的概念，且可以更加有效地分配IPv4的地址空间

CIDR用法：使用斜线记法，在IPv4地址后面加上斜线，斜线后写了网络前缀所占用的bit数量。CIDR实际上就是将网络前缀都相同的连续IP地址组成一个CIDR地址块。

在已知一个CIDR地址块后，**可以根据此求出最小地址（全0）、最大地址（全1）、地址数量（仍要计算网络地址和广播地址）、聚合C类网的数量以及地址掩码**

#### 路由聚合（构造超网） 

目的：减少路由表中的冗余网络号记录的过多占用

方法：**先找路由表项中的共同前缀（最长匹配），得到CIDR类型的聚合块地址，记录到路由器的路由表当中**

网络前缀越长，地址块越小，路由就越具体。

### IPv4地址的应用规划

目的：给定一个IPv4地址块（A or B or C类网络），如何将其划分为更小的地址块

两种方法：根据定长的子网掩码（FLSM）和根据变长的子网掩码（VLSM）

FLSM：使用同一个子网掩码划分子网，每个子网分配的IP地址数量相同，容易造成IP地址的浪费；而VLSM不会出现这样问题

地址需求的计算：Sum = 主机地址+路由器接口地址+网络地址+广播地址

FLSM方法：分别找各个网络中的Sum，找到最大的Sum之后，将块都划分为接近Sum_Max的块然后逐个分配。但这样容易造成

VLSM方法：分别找对应网络的Sum然后分别处理，分别取出对应大小的（空间接近的）地址块分配，先给大的子块进行分配，其次分配小的地址块（**从地址块的地址开始按序分配，例如192.168.252.0/24要分配63空间大小的块，则192.168.252.0/25就是分配起始地址，该块的广播地址为192.168.252.62/25**）

### IP数据报的发送和转发过程

包含以下两部分：主机发送IP数据报，路由器转发IP数据报 

如何判断接收方与发送方不在同一个网络内呢？**将接收方的地址与发送方的子网掩码相与，得到的结果若与发送方的网络地址不同，则说明不在同一个网络。**

发送方如何知道该通过哪个路由器转发呢？**通过该主机指定的默认网关（指定的路由器）转发，由默认网关转发出去。**

路由器收到IP数据报又是如何转发的呢？**首先检查数据报首部是否出错，出错则丢弃数据报并通告源主机，没有则转发，根据目的地址在路由表中查找匹配项目（查找是通过目的地址与地址掩码相与，将结果与目的网络相比较），若找到，则转发到条目中指示的下一跳，否则丢弃该数据报并通告源主机。**

注：路由器并不会接收广播

### 拥塞控制和流量控制

拥塞控制：防止整个网络或网络的一部分出现过多的数据包

流量控制：保证发送方发送的信息量不会超过接收方的接受能力

### 静态路由配置（TTL和黑洞路由问题）

定义：使用路由器的相关命令给路由器人工配置路由器（路由器是网络层互连主要设备）

注：路由器和交换机的区别？1.工作层次不同

为什么要人工配置呢？**若信息要经过多个网络，可能前面的路由器路由表中没有后面路由器的IP地址，需要人工添加，类型为静态，**否则类型为直连。

默认路由和特定路由

**默认路由是将目的网络填写为0.0.0.0/0，下一跳直接填写对应路由表的IP地址，当没有匹配结果的时候即会跳转到默认路由；特定路由是目的网络即是接收方的IP地址，下一跳填接收方的默认路由，这两种路由添加类型都为静态。特定主机路由网络前缀最长，路由最具体；默认路由网络前缀最短，路由最模糊。当有多条路由可选时，采取最长前缀匹配原则。**

静态路由配置错误会导致路由环路问题。解决办法：为路由条目设立生存时间TTL，访问一次则值减一，为0则清除

聚合不存在的网络也会导致路由环路问题。原因：聚合之后会有空的IP地址，解决办法：为空的IP地址添加黑洞路由，要转发到空IP地址时，直接抛弃数据报

### 路由选择协议（待看完后面之后重新来看）

分为两种：静态路由选择和动态路由选择

静态路由选择：采用人工配置方式添加网络路由、默认路由、特定主机路由、黑洞路由。特点：简单方便但很麻烦

动态路由选择：路由器通过路由选择协议自动获取路由信息。特点：结构复杂却适应性很强

因特网采取的路由选择协议的主要特点：自适应、分布式、分层次

常见路由选择协议

内部网关协议IGP：RIP、OSPF

外部网关协议BGP：BGP

路由器的基本结构：路由选择部分和分组转发部分

### *路由信息协议RIP的基本原理

RIP属于内部网关协议IGP

RIP要求自治系统AS内每一个路由器都要维护从它自己到AS内其它每一个网络的距离记录。这是一组距离，称为“距离向量D-V”

RIP使用跳数作为度量来衡量到达目的网络的距离

1. 路由器到直连网络距离定义为1
2. 路由器到非直连网络的距离定义为所经过的路由器数加1
3. 允许一条路径最多只能包含15个路由器，距离等于16相当于不可达，故RIP只适用于小型互联网

RIP认为好的路由就是距离短（通过路由器数量最少）的路由，当有多条“距离相等”的路由时，可以进行等价负载均衡

RIP的三个要点

1. 仅和相邻路由器交换信息（和谁交换信息）
2. 交换自己的路由表（交换什么信息）
3. 每30s交换一次（何时交换信息）

RIP的基本工作过程

1. 路由刚开始工作时，只知道自己到直连网络的距离为1
2. 每个路由器仅和相邻路由器周期性地交换并更新路由信息
3. 若干次交换和更新后，若路由器知道该AS内各网络的最短距离以及下一跳地址，则该路由器收敛

RIP路由条目的更新规则

1. 当路由器A将其路由表传给路由器B时，路由器B要对A的路由表进行改造，首先将A路由表的目的网络下一跳都改为A，距离都增加1
2. 根据改造好的路由表更新自己先前的路由表，**若到达目的网络存在相同下一跳，最新消息则更新；若发现新的网络则添加；若到达目的网络不同的下一跳，新路由优势则更新；若到达目的网络，不同下一跳，则等价负载均衡；若劣势则不更新**

RIP中存在的问题：“坏消息传播得慢”

若一个网络N1与路由器A线路发生故障时（A->N1不可达），其会影响其它路由器，但另一个路由器B的信息（B->N2->A->N1是可达的）会先到A，使得A被误导认为N1通过B是可达的，之后A路由器信息更新到B，B被误导认为N1通过A是可达的......如此以往，最终会收敛，中间会发生路由环路问题。

### *开放最短路径OSPF协议基本工作原理

目的：为了克服RIP的缺点而开发。“开放”表明OSPF是公开发表的，“最短路径优先”是使用了Dijkstra提出的最短路径算法SPF

OSPF是基于链路状态的，并非像RIP一样基于距离向量的

OSPF采用SPF算法计算路由，从算法上保证了不会产生路由环路

OSPF不限制网络规模，更新效率高，收敛速度快

链路状态是指本路由器都和哪些路由器相邻，以及相应链路的“代价”

使用OSPF的每个路由器都会产生**链路状态通告LSA**，LSA中包含直连网络的链路状态信息以及邻居路由器的链路状态信息

LSA被封装在**链路状态更新分组LSU**中，采用洪泛法发送

通过各路由器洪泛发送封装有自己LSA的LSU分组，各路由器的LSDB最终会达到一致

使用OSPF的各路由器基于LSDB进行最短路径优先SPF计算，构建出各自到达其他各路由器的最短路径，即构建各自的路由表

#### Dijkstra算法

在Dijkstra算法中节点有两种类型：网络和路由器

在Dijkstra中从路由器到网络的链路的费用有效，而从网络到路由器的链路的费用总是为0。

#### OSPF相互更新LSDB的过程

OSPF有五种分组类型：问候（Hello）分组、数据库描述分组、链路状态请求分组、链路状态更新分组、链路状态确认分组



#### OSPF在多点接入网络中路由器邻居关系的建立

目的：减少网络层中的LSU传播数量，优化洪泛方法

1. 选举指定路由器DR和BDR
2. 将所有的非DR和BDR与其建立邻居关系
3. 非DR/BDR之间通过DR/BDR交换信息



为了使OSPF能够用于大规模的网络，OSPF将一个AS再划分为若干个区域（Area）。其好处就是把利用洪泛法交换链路状体信息的范围局限于每一个区域而不是整个自治系统，减少了整个网络上的通信量。



### 边界网关协议BGP的基本工作原理

BGP是外部网关，用于AS之间的路由选择。但由于不同的AS内部度量路由的代价可能不同，故对于AS之间的路由选择不可用代价作为度量标准。

寻找最佳路由需要有统一的度量，而AS之间的路由选择必须考虑相关策略（政治、经济、安全等）

故BGP只能是寻找一条能够到达目的网络且比较好的路径，不一定是最佳路径

#### BGP基本工作原理

1. 首先每个AS的admin需要选择至少一个路由器作为该AS的“BGP发言人”
2. 不同AS之间交换信息**必须建立TCP连接**，端口号为179。在此TCP连接上交换BGP报文以建立BGP会话，利用该BGP会话交换路由信息；使用TCP连接交换路由信息的两个BGP发言人彼此称为对方的邻站或对等站
3. 发言人除运行BGP外，还必须运行自身AS所使用的内部网关协议IGP，例如OSPF或RIP
4. BGP发言人之间交换可达性的信息
5. 根据策略找出各个AS的较好的路由，也就是构造出树形结构，不存在回路的AS连通图。

BGP适用于多级结构（其实就是树形结构）的因特网

BGP-4中的四种报文

1. OPEN报文：与相邻的BGP发言人建立关系，初始化通信
2. UPDATE报文：用来通告某一路由的信息
3. KEEPACTIVE报文：用来周期性地证实邻站的连通性
4. NOTIFICATION报文：用来发送检测到的差错



### IPv4数据报的首部格式

IPv4数据报简称IP数据报

由20字节的固定部分（必须存在）和40字节的可变部分（不一定存在）

IP数据报一般以32位也就是4个字节作为基本单位



### 网际控制报文协议ICMP

目的：为了更有效地转发IP数据报和提高交付成功的机会。

主机或路由器使用ICMP发送差错报告报文和询问报文

**ICMP报文被封装在IP数据报中发送**

ICMP差错报文有五种情况：终点不可达、源点抑制（由于拥塞而丢弃时）、时间超过（TTL的值为0）、参数问题（出现误码）、改变路由

以下情况不发送ICMP差错报告报文

1. 对ICMP差错报告报文不发送ICMP
2. 对第一个分片的数据报片的所有后续数据报片都不发送ICMP差错报告报文
3. 对具有多播地址的数据报都不发送ICMP差错报告报文
4. 对具有特殊地址的数据报不发送ICMP差错报告报文

ICMP询问报文有两种情况：

1. 回送请求和回答：由主机或路由器向一个特定的目的主机发出的询问，收到此报文的主机必须给源主机或路由器发送ICMP回送回答报文，这种询问报文用来**测试目的站是否可达以及了解其有关状态**
2. 时间戳请求和回答：是请某个主机或路由器回答当前的日期和时间，该询问报文用来**进行时钟同步和测量时间**



### 虚拟专用网VPN和网络地址转换NAT

VPN：利用公用的因特网作为本机构各专用网之间的通信载体。

由于IPv4地址的紧缺，虚拟专用网中各主机所分配的地址应该是本机构可自由分配的专用地址，而不是需要申请的，在因特网上使用的公有地址。

私有地址和共有地址

私有地址只能在网络内部进行数据传输使用，路由器针对私有地址不会进行转发

公有地址

NAT目的：缓解了IPv4地址空间即将耗尽的问题

NAT能使大量使用内部专用地址的专用网络用户共享少量外部全球地址来访问因特网上的主机和资源

NAT路由器：至少存在以一个全球IP地址 



